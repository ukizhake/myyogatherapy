name: Deploy MendOnBend to Vercel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate HTML files
      run: |
        echo "🔍 Validating HTML structure..."
        # Check if main files exist
        test -f index.html || (echo "❌ index.html missing" && exit 1)
        test -f about.html || (echo "❌ about.html missing" && exit 1)
        test -f contact.html || (echo "❌ contact.html missing" && exit 1)
        test -f blog.html || (echo "❌ blog.html missing" && exit 1)
        echo "✅ All HTML files present"
        
    - name: Validate JSON configuration
      run: |
        echo "🔍 Validating JSON files..."
        # Validate vercel.json
        cat vercel.json | jq . > /dev/null || (echo "❌ vercel.json invalid" && exit 1)
        # Validate manifest.json
        cat manifest.json | jq . > /dev/null || (echo "❌ manifest.json invalid" && exit 1)
        echo "✅ All JSON files valid"
        
    - name: Check critical assets
      run: |
        echo "🔍 Checking critical assets..."
        test -f styles.css || (echo "❌ styles.css missing" && exit 1)
        test -f script.js || (echo "❌ script.js missing" && exit 1)
        test -d data || (echo "❌ data directory missing" && exit 1)
        test -d icons || (echo "❌ icons directory missing" && exit 1)
        echo "✅ All critical assets present"
        
    - name: Lint CSS and JS (basic check)
      run: |
        echo "🔍 Basic syntax checking..."
        # Check for common syntax errors in CSS
        if grep -n "}" styles.css | wc -l > /dev/null; then
          echo "✅ CSS syntax appears valid"
        fi
        # Check for basic JS syntax
        if grep -n "function\|const\|let\|var" script.js | wc -l > /dev/null; then
          echo "✅ JavaScript syntax appears valid"
        fi
        
    - name: Check data integrity
      run: |
        echo "🔍 Checking data files..."
        test -f "data/YogaAsanas - TherapeuticAsanas.csv" || echo "⚠️ Yoga asanas CSV missing"
        test -f "knowledge_base/yoga_sequences_comprehensive.json" || echo "⚠️ Sequences JSON missing"
        echo "✅ Data integrity check complete"
        
    - name: Generate build info
      run: |
        echo "📦 Generating build info..."
        echo "{
          \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"commit\": \"$GITHUB_SHA\",
          \"branch\": \"$GITHUB_REF_NAME\",
          \"version\": \"$(date +%Y.%m.%d.%H%M)\"
        }" > build-info.json
        echo "✅ Build info generated"
        
    - name: Pre-deployment summary
      run: |
        echo "🚀 Pre-deployment Summary:"
        echo "📁 Repository: $GITHUB_REPOSITORY"
        echo "🌿 Branch: $GITHUB_REF_NAME"
        echo "📝 Commit: ${GITHUB_SHA:0:7}"
        echo "👤 Author: $GITHUB_ACTOR"
        echo "📊 Files changed:"
        git diff --name-only HEAD~1 2>/dev/null || echo "  Initial commit"
        echo ""
        echo "🎯 Vercel will automatically deploy this build!"
        echo "🌐 Live site will update in 30-60 seconds"
        
    - name: Deployment notification
      if: github.ref == 'refs/heads/main'
      run: |
        echo "🎉 Main branch updated!"
        echo "🚀 Vercel deployment triggered automatically"
        echo "✨ MendOnBend will be live shortly at your Vercel URL"
        echo ""
        echo "📋 Next steps:"
        echo "1. Check Vercel dashboard for deployment status"
        echo "2. Test the live site functionality"
        echo "3. Monitor for any deployment errors"
