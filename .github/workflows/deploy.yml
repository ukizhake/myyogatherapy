name: Deploy MendOnBend to Vercel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate HTML files
      run: |
        echo "ğŸ” Validating HTML structure..."
        # Check if main files exist
        test -f index.html || (echo "âŒ index.html missing" && exit 1)
        test -f about.html || (echo "âŒ about.html missing" && exit 1)
        test -f contact.html || (echo "âŒ contact.html missing" && exit 1)
        test -f blog.html || (echo "âŒ blog.html missing" && exit 1)
        echo "âœ… All HTML files present"
        
    - name: Validate JSON configuration
      run: |
        echo "ğŸ” Validating JSON files..."
        # Validate vercel.json
        cat vercel.json | jq . > /dev/null || (echo "âŒ vercel.json invalid" && exit 1)
        # Validate manifest.json
        cat manifest.json | jq . > /dev/null || (echo "âŒ manifest.json invalid" && exit 1)
        echo "âœ… All JSON files valid"
        
    - name: Check critical assets
      run: |
        echo "ğŸ” Checking critical assets..."
        test -f styles.css || (echo "âŒ styles.css missing" && exit 1)
        test -f script.js || (echo "âŒ script.js missing" && exit 1)
        test -d data || (echo "âŒ data directory missing" && exit 1)
        test -d icons || (echo "âŒ icons directory missing" && exit 1)
        echo "âœ… All critical assets present"
        
    - name: Lint CSS and JS (basic check)
      run: |
        echo "ğŸ” Basic syntax checking..."
        # Check for common syntax errors in CSS
        if grep -n "}" styles.css | wc -l > /dev/null; then
          echo "âœ… CSS syntax appears valid"
        fi
        # Check for basic JS syntax
        if grep -n "function\|const\|let\|var" script.js | wc -l > /dev/null; then
          echo "âœ… JavaScript syntax appears valid"
        fi
        
    - name: Check data integrity
      run: |
        echo "ğŸ” Checking data files..."
        test -f "data/YogaAsanas - TherapeuticAsanas.csv" || echo "âš ï¸ Yoga asanas CSV missing"
        test -f "knowledge_base/yoga_sequences_comprehensive.json" || echo "âš ï¸ Sequences JSON missing"
        echo "âœ… Data integrity check complete"
        
    - name: Generate build info
      run: |
        echo "ğŸ“¦ Generating build info..."
        echo "{
          \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"commit\": \"$GITHUB_SHA\",
          \"branch\": \"$GITHUB_REF_NAME\",
          \"version\": \"$(date +%Y.%m.%d.%H%M)\"
        }" > build-info.json
        echo "âœ… Build info generated"
        
    - name: Pre-deployment summary
      run: |
        echo "ğŸš€ Pre-deployment Summary:"
        echo "ğŸ“ Repository: $GITHUB_REPOSITORY"
        echo "ğŸŒ¿ Branch: $GITHUB_REF_NAME"
        echo "ğŸ“ Commit: ${GITHUB_SHA:0:7}"
        echo "ğŸ‘¤ Author: $GITHUB_ACTOR"
        echo "ğŸ“Š Files changed:"
        git diff --name-only HEAD~1 2>/dev/null || echo "  Initial commit"
        echo ""
        echo "ğŸ¯ Vercel will automatically deploy this build!"
        echo "ğŸŒ Live site will update in 30-60 seconds"
        
    - name: Deployment notification
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ‰ Main branch updated!"
        echo "ğŸš€ Vercel deployment triggered automatically"
        echo "âœ¨ MendOnBend will be live shortly at your Vercel URL"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Check Vercel dashboard for deployment status"
        echo "2. Test the live site functionality"
        echo "3. Monitor for any deployment errors"
